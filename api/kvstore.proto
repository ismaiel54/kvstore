syntax = "proto3";

package kvstore;

option go_package = "kvstore/internal/gen/kvstorepb";

// KVStore service definition (client-facing)
service KVStore {
  rpc Put(PutRequest) returns (PutResponse);
  rpc Get(GetRequest) returns (GetResponse);
  rpc Delete(DeleteRequest) returns (DeleteResponse);
}

// KVInternal service definition (internal replica operations)
service KVInternal {
  rpc ReplicaPut(ReplicaPutRequest) returns (ReplicaPutResponse);
  rpc ReplicaGet(ReplicaGetRequest) returns (ReplicaGetResponse);
  rpc ReplicaDelete(ReplicaDeleteRequest) returns (ReplicaDeleteResponse);
}

// Membership service for gossip-based membership and failure detection
service Membership {
  rpc Ping(PingRequest) returns (PingResponse);
  rpc Gossip(GossipRequest) returns (GossipResponse);
  rpc GetMembership(GetMembershipRequest) returns (GetMembershipResponse);
}

// Vector clock entry
message VectorClockEntry {
  string node_id = 1;
  int64 counter = 2;
}

// Vector clock (map of node_id -> counter)
message VectorClock {
  repeated VectorClockEntry entries = 1;
}

// Put request
message PutRequest {
  string key = 1;
  bytes value = 2;
  int64 ttl_ms = 3;  // Optional TTL in milliseconds (0 = no expiration)
  int32 consistency_r = 4;  // Read quorum size (optional, uses default if 0)
  int32 consistency_w = 5;  // Write quorum size (optional, uses default if 0)
  string client_id = 6;  // Client identifier for tracking
  string request_id = 7;  // Request identifier for tracing
  VectorClock version = 8;  // Optional: client-provided version for conflict resolution
}

// Put response
message PutResponse {
  enum Status {
    SUCCESS = 0;
    ERROR = 1;
    CONFLICT = 2;
  }
  Status status = 1;
  string error_message = 2;
  VectorClock version = 3;  // New version after write
}

// Get request
message GetRequest {
  string key = 1;
  int32 consistency_r = 2;  // Read quorum size (optional, uses default if 0)
  string client_id = 3;
  string request_id = 4;
}

// Value with version
message VersionedValue {
  bytes value = 1;
  VectorClock version = 2;
  bool deleted = 3;  // True if this is a tombstone (deleted)
}

// Get response
message GetResponse {
  enum Status {
    SUCCESS = 0;
    NOT_FOUND = 1;
    ERROR = 2;
  }
  Status status = 1;
  VersionedValue value = 2;  // Single value if no conflicts
  repeated VersionedValue conflicts = 3;  // Multiple values if concurrent writes
  string error_message = 4;
}

// Delete request
message DeleteRequest {
  string key = 1;
  int32 consistency_r = 2;
  int32 consistency_w = 3;
  string client_id = 4;
  string request_id = 5;
  VectorClock version = 6;  // Optional: version to delete
}

// Delete response
message DeleteResponse {
  enum Status {
    SUCCESS = 0;
    NOT_FOUND = 1;
    ERROR = 2;
  }
  Status status = 1;
  string error_message = 2;
  VectorClock version = 3;  // Version after deletion
}

// Internal replica operations

// ReplicaPut request (from coordinator to replica)
message ReplicaPutRequest {
  string key = 1;
  bytes value = 2;
  VectorClock version = 3;  // Version to write
  string coordinator_id = 4;
  string request_id = 5;
  bool deleted = 6;  // True for tombstone (delete)
  bool is_repair = 7;  // True if this is a read repair operation (prevents clock increments)
}

// ReplicaPut response
message ReplicaPutResponse {
  enum Status {
    SUCCESS = 0;
    ERROR = 1;
  }
  Status status = 1;
  string error_message = 2;
}

// ReplicaGet request (from coordinator to replica)
message ReplicaGetRequest {
  string key = 1;
  string coordinator_id = 2;
  string request_id = 3;
}

// ReplicaGet response
message ReplicaGetResponse {
  enum Status {
    SUCCESS = 0;
    NOT_FOUND = 1;
    ERROR = 2;
  }
  Status status = 1;
  VersionedValue value = 2;  // Value with version
  string error_message = 3;
}

// ReplicaDelete request (from coordinator to replica)
message ReplicaDeleteRequest {
  string key = 1;
  VectorClock version = 2;  // Version for deletion
  string coordinator_id = 3;
  string request_id = 4;
}

// ReplicaDelete response
message ReplicaDeleteResponse {
  enum Status {
    SUCCESS = 0;
    NOT_FOUND = 1;
    ERROR = 2;
  }
  Status status = 1;
  string error_message = 2;
}

// Membership messages

// MemberStatus represents the state of a cluster member
enum MemberStatus {
  ALIVE = 0;
  SUSPECT = 1;
  DEAD = 2;
}

// Member represents a cluster member
message Member {
  string id = 1;
  string addr = 2;
  MemberStatus status = 3;
  uint64 incarnation = 4;  // Increments on state changes to resolve conflicts
  uint64 last_seen_unix_ms = 5;  // Unix timestamp in milliseconds
}

// PingRequest is used for failure detection probes
message PingRequest {
  string from_id = 1;
  uint64 timestamp_ms = 2;  // Unix timestamp in milliseconds
  repeated Member membership = 3;  // Optional: piggyback membership changes
}

// PingResponse acknowledges a ping
message PingResponse {
  string responder_id = 1;
  uint64 timestamp_ms = 2;
  repeated Member membership = 3;  // Optional: return membership snapshot
}

// GossipRequest propagates membership information
message GossipRequest {
  string from_id = 1;
  repeated Member membership = 2;  // Sender's membership view
}

// GossipResponse acknowledges gossip
message GossipResponse {
  string responder_id = 1;
  repeated Member membership = 2;  // Optional: responder's membership view
}

// GetMembershipRequest requests current membership state (debug/admin)
message GetMembershipRequest {
  // Empty for now, can be extended
}

// GetMembershipResponse returns current membership state
message GetMembershipResponse {
  repeated Member members = 1;
  string local_node_id = 2;
}

